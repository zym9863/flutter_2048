name: Build and Release

on:
  push:
    tags:
      - 'v*' # å½“æ¨é€ä»¥ v å¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.0' # ä½¿ç”¨ç¨³å®šç‰ˆæœ¬
        channel: 'stable'
        
    - name: Enable Windows desktop
      run: flutter config --enable-windows-desktop
      
    - name: Install dependencies
      run: flutter pub get
      
    - name: Build Windows app
      run: flutter build windows --release
      
    - name: Create Windows release archive
      run: |
        cd build/windows/x64/runner/Release
        7z a -tzip ../../../../../flutter_2048_windows.zip *
      
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: windows-release
        path: flutter_2048_windows.zip

  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.0'
        channel: 'stable'
        
    - name: Install dependencies
      run: flutter pub get
      
    - name: Build Android APK
      run: flutter build apk --release --split-per-abi
      
    - name: Upload Android artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-release
        path: build/app/outputs/flutter-apk/*.apk

  release:
    needs: [build-windows, build-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: windows-release
        path: ./artifacts/
        
    - name: Download Android artifacts
      uses: actions/download-artifact@v4
      with:
        name: android-release
        path: ./artifacts/
        
    - name: Get tag name
      id: tag
      run: echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.tag.outputs.tag }}
        name: Flutter 2048 ${{ steps.tag.outputs.tag }}
        body: |
          ## Flutter 2048 Release ${{ steps.tag.outputs.tag }}
          
          ### ğŸ“¦ Downloads
          - **Windows**: `flutter_2048_windows.zip` - Windowsæ¡Œé¢åº”ç”¨ç¨‹åº
          - **Android**: 
            - `app-arm64-v8a-release.apk` - ARM64è®¾å¤‡ï¼ˆæ¨èï¼Œç°ä»£æ‰‹æœºï¼‰
            - `app-armeabi-v7a-release.apk` - ARM32è®¾å¤‡ï¼ˆè€æ—§æ‰‹æœºï¼‰
            - `app-x86_64-release.apk` - x86_64è®¾å¤‡ï¼ˆæ¨¡æ‹Ÿå™¨/å¹³æ¿ï¼‰
          
          ### ğŸ® æ¸¸æˆè¯´æ˜
          è¿™æ˜¯ä¸€ä¸ªç»å…¸çš„2048ç›Šæ™ºæ¸¸æˆçš„Flutterå®ç°ã€‚
          
          ### ğŸ’¾ å®‰è£…è¯´æ˜
          **Windows**: ä¸‹è½½å¹¶è§£å‹ `flutter_2048_windows.zip`ï¼Œè¿è¡Œ `flutter_2048.exe`
          
          **Android**: æ ¹æ®ä½ çš„è®¾å¤‡ç±»å‹ä¸‹è½½å¯¹åº”çš„APKæ–‡ä»¶å¹¶å®‰è£…
          - å¤§å¤šæ•°ç°ä»£Androidæ‰‹æœºè¯·ä¸‹è½½ `app-arm64-v8a-release.apk`
          - è¾ƒè€çš„æ‰‹æœºè¯·ä¸‹è½½ `app-armeabi-v7a-release.apk`
          
        draft: false
        prerelease: false
        files: |
          ./artifacts/flutter_2048_windows.zip
          ./artifacts/*.apk
        token: ${{ secrets.GITHUB_TOKEN }}
